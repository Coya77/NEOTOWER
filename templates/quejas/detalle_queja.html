<!-- templates/quejas/detalle_queja.html -->
{% extends "base.html" %}

{% block title %}Detalle de Queja - NEOTOWER{% endblock %}

{% block content %}
<style>
    :root {
        --color-azul: #0e648b;
        --color-verde: #209278;
        --color-verde-claro: #299f83;
    }

    body {
        background: linear-gradient(135deg, #0e648b 0%, #209278 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container-custom {
        min-height: 100vh;
        padding: 20px;
    }

    .card-custom {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .card-header-custom {
        background: linear-gradient(135deg, var(--color-azul) 0%, var(--color-verde) 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--color-azul) 0%, var(--color-verde) 100%);
        border: none;
        border-radius: 8px;
        font-weight: 600;
    }

    .badge-estado-pendiente { background-color: #0e648b; color: white; }
    .badge-estado-en_proceso { background-color: #ffc107; color: black; }
    .badge-estado-respondida { background-color: #198754; color: white; }
    .badge-estado-resuelta { background-color: #6c757d; color: white; }

    .badge-prioridad-urgente { background-color: #dc3545; color: white; }
    .badge-prioridad-alta { background-color: #fd7e14; color: white; }
    .badge-prioridad-media { background-color: #0e648b; color: white; }
    .badge-prioridad-baja { background-color: #6c757d; color: white; }

    .badge-tipo-sugerencia { background-color: #17a2b8; color: white; }
    .badge-tipo-queja { background-color: #ffc107; color: black; }
    .badge-tipo-reclamo { background-color: #dc3545; color: white; }
    .badge-tipo-felicitacion { background-color: #28a745; color: white; }
</style>

<div class="container-custom">
    <div class="card-custom">
        <div class="card-header-custom p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="bi 
                        {% if queja.tipo == 'sugerencia' %}bi-lightbulb text-info
                        {% elif queja.tipo == 'queja' %}bi-exclamation-triangle text-warning
                        {% elif queja.tipo == 'reclamo' %}bi-flag text-danger
                        {% else %}bi-hand-thumbs-up text-success{% endif %} me-2"></i>
                        {{ queja.asunto or 'Sin asunto' }} (ID: {{ queja.id_queja }})</h2>
                    <small class="opacity-75">Detalles completos de tu mensaje</small>
                </div>
                <div>
                    {% if session.user_rol == 'administrador' %}
                        <a href="{{ url_for('buzon.gestion_quejas') }}" class="btn btn-outline-light me-2">
                            <i class="bi bi-arrow-left me-1"></i>Volver a Gestión
                        </a>
                    {% else %}
                        <a href="{{ url_for('buzon.mis_quejas') }}" class="btn btn-outline-light me-2">
                            <i class="bi bi-arrow-left me-1"></i>Volver a Mis Quejas
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card-body p-4">
            <!-- Mensajes flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if queja %}
            <!-- Información Principal -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h5 class="mb-3"><i class="bi bi-chat-text me-2 text-primary"></i>Descripción</h5>
                    <p class="lead" style="white-space: pre-line;">{{ queja.descripcion or 'Sin descripción' }}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>Detalles</h6>
                    <div class="row text-muted small">
                        <div class="col-6 mb-2">
                            <strong>Tipo:</strong><br>
                            <span class="badge 
                                {% if queja.tipo == 'sugerencia' %}badge-tipo-sugerencia
                                {% elif queja.tipo == 'queja' %}badge-tipo-queja
                                {% elif queja.tipo == 'reclamo' %}badge-tipo-reclamo
                                {% else %}badge-tipo-felicitacion{% endif %}">
                                {{ queja.tipo|title or 'N/A' }}
                            </span>
                        </div>
                        <div class="col-6 mb-2">
                            <strong>Prioridad:</strong><br>
                            <span class="badge 
                                {% if queja.prioridad == 'urgente' %}badge-prioridad-urgente
                                {% elif queja.prioridad == 'alta' %}badge-prioridad-alta
                                {% elif queja.prioridad == 'media' %}badge-prioridad-media
                                {% else %}badge-prioridad-baja{% endif %}">
                                {{ queja.prioridad|title or 'N/A' }}
                            </span>
                        </div>
                        <div class="col-6 mb-2">
                            <strong>Estado:</strong><br>
                            <span class="badge 
                                {% if queja.estado == 'pendiente' %}badge-estado-pendiente
                                {% elif queja.estado == 'en_proceso' %}badge-estado-en_proceso
                                {% elif queja.estado == 'respondida' %}badge-estado-respondida
                                {% else %}badge-estado-resuelta{% endif %}">
                                {{ queja.estado|replace('_', ' ')|title or 'N/A' }}
                            </span>
                        </div>
                        <div class="col-6 mb-2">
                            <strong>Modo:</strong><br>
                            {% if queja.anonimo %}
                            <span class="badge bg-secondary">Anónimo</span>
                            {% else %}
                            <span class="badge bg-primary">Público</span>
                            {% endif %}
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Enviado por:</strong><br>
                            {% if queja.anonimo %}
                                <span class="text-muted">Usuario anónimo</span>
                            {% else %}
                                {{ queja.nombre_usuario or 'Usuario desconocido' }}
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <strong>Fecha de Envío:</strong><br>
                            <span class="text-muted">{{ queja.fecha_creacion.strftime('%d/%m/%Y %H:%M') if queja.fecha_creacion else 'N/A' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Respuesta Existente (si hay) -->
            {% if queja.respuesta %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success bg-opacity-10">
                            <h6 class="mb-0 text-success"><i class="bi bi-reply me-2"></i>Respuesta de la Administración</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2" style="white-space: pre-line;">{{ queja.respuesta }}</p>
                            {% if queja.fecha_respuesta %}
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Respondido el: {{ queja.fecha_respuesta.strftime('%d/%m/%Y %H:%M') }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Form Responder (solo para admin y estados pendientes/en_proceso) -->
            {% if puede_responder and queja.estado in ['pendiente', 'en_proceso'] %}
            <div class="row">
                <div class="col-12">
                    <h5 class="mb-3"><i class="bi bi-reply-all me-2 text-success"></i>Responder a esta Queja</h5>
                    <form method="POST" action="{{ url_for('buzon.responder_queja', id_queja=queja.id_queja) }}">
                        <div class="mb-3">
                            <label for="respuesta" class="form-label fw-bold">Tu Respuesta *</label>
                            <textarea class="form-control" id="respuesta" name="respuesta" 
                                      rows="5" placeholder="Escribe una respuesta clara y detallada. Esta se enviará al usuario y actualizará el estado a 'respondida'." 
                                      required maxlength="1000"></textarea>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i> Sé empático y profesional. Máximo 1000 caracteres.
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send me-1"></i>Enviar Respuesta
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% elif puede_responder and queja.estado in ['respondida', 'resuelta'] %}
            <div class="alert alert-info">
                <i class="bi bi-check-circle me-2"></i>Esta queja ya ha sido respondida o resuelta.
            </div>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-exclamation-triangle display-1 text-muted mb-3"></i>
                <h4 class="text-muted mb-3">Queja no encontrada</h4>
                <p class="text-muted">El mensaje que buscas no existe o ha sido eliminado.</p>
                {% if session.user_rol == 'administrador' %}
                    <a href="{{ url_for('buzon.gestion_quejas') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Volver a Gestión
                    </a>
                {% else %}
                    <a href="{{ url_for('buzon.mis_quejas') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Volver a Mis Quejas
                    </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}