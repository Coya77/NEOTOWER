{% extends "base.html" %} 
{% block title %}Mis Pagos{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2 class="fw-bold text-primary mb-3">
    <i class="bi bi-cash-stack"></i> Mis Pagos
  </h2>

  <!-- üîπ RESUMEN GENERAL -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="alert alert-success text-center shadow-sm">
        <strong>Total Pagado:</strong><br>{{ "%.2f"|format(total_pagado or 0) }} Bs
      </div>
    </div>
    <div class="col-md-4">
      <div class="alert alert-warning text-center shadow-sm">
        <strong>Total Pendiente:</strong><br>{{ "%.2f"|format(total_pendiente or 0) }} Bs
      </div>
    </div>
    <div class="col-md-4">
      <div class="alert alert-danger text-center shadow-sm">
        <strong>Total Moroso:</strong><br>{{ "%.2f"|format(total_moroso or 0) }} Bs
      </div>
    </div>
  </div>


{% if pagos %}
<div class="row text-center mb-4">
  <div class="col-md-4">
    <div class="alert alert-success p-2">
      <strong>Total Pagado:</strong> {{ "%.2f"|format(total_pagado) }} Bs
    </div>
  </div>
  <div class="col-md-4">
    <div class="alert alert-warning p-2">
      <strong>Pendiente:</strong> {{ "%.2f"|format(total_pendiente) }} Bs
    </div>
  </div>
  <div class="col-md-4">
    <div class="alert alert-danger p-2">
      <strong>Moroso:</strong> {{ "%.2f"|format(total_moroso) }} Bs
    </div>
  </div>
</div>
{% endif %}



  {% if pagos %}
  <table class="table table-striped align-middle text-center shadow-sm">
    <thead class="table-primary">
      <tr>
        
        <th>Monto (Bs.)</th>
        <th>Estado</th>
        <th>Situaci√≥n</th>
        <th>D√≠as Retraso</th>
        <th>Fecha</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pagos %}
      <tr>
        <td>{{ p.id_pago }}</td>
        <td>{{ "%.2f"|format(p.monto) }}</td>

        <!-- Estado -->
        <td>
          {% if p.estado|lower == "pagado" %}
            <span class="badge bg-success">Pagado</span>
          {% elif p.estado|lower == "pendiente" %}
            <span class="badge bg-warning text-dark">Pendiente</span>
          {% else %}
            <span class="badge bg-secondary">{{ p.estado }}</span>
          {% endif %}
        </td>

        <!-- Situaci√≥n -->
        <td>
          {% if p.situacion == "Moroso" %}
            <span class="badge bg-danger">Moroso</span>
          {% elif p.situacion == "Pendiente" %}
            <span class="badge bg-warning text-dark">Pendiente</span>
          {% else %}
            <span class="badge bg-success">Al d√≠a</span>
          {% endif %}
        </td>

        <!-- D√≠as retraso -->
        <td>{{ p.dias_retraso or 0 }}</td>

        <!-- Fecha -->
        <td>
          {% if p.fecha_pago %}
            {{ p.fecha_pago.strftime('%d/%m/%Y') }}
          {% elif p.fecha %}
            {{ p.fecha.strftime('%d/%m/%Y') }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>

        <!-- Acci√≥n -->
        <td>
          {% if p.estado|lower == "pendiente" %}
            <button class="btn btn-success btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalPagar"
                    data-id="{{ p.id_pago }}"
                    data-monto="{{ p.monto }}">
              <i class="bi bi-cash"></i> Pagar ahora
            </button>
          {% else %}
            <a href="{{ url_for('static', filename='comprobantes/comprobante_' ~ p.id_pago ~ '.pdf') }}" 
               class="btn btn-outline-primary btn-sm" target="_blank">
              <i class="bi bi-file-earmark-pdf"></i> Ver comprobante
            </a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="alert alert-info text-center">
    No tienes pagos registrados.
  </div>
  {% endif %}
</div>

<!-- ========================================= -->
<!-- MODAL DE PAGO -->
<!-- ========================================= -->
<div class="modal fade" id="modalPagar" tabindex="-1" aria-labelledby="modalPagarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('pagar_servicio') }}">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-credit-card"></i> Realizar pago</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="id_pago" name="id_pago">
          <p><strong>Monto a pagar:</strong> <span id="monto_pago"></span> Bs</p>

          <!-- Selecci√≥n del m√©todo -->
          <div class="mb-3">
            <label class="form-label">M√©todo de pago</label>
            <select name="metodo" id="metodo" class="form-select" required>
              <option value="" selected disabled>Seleccionar m√©todo</option>
              <option value="tarjeta">üí≥ Tarjeta</option>
              <option value="transferencia">üè¶ Transferencia bancaria</option>
              <option value="qr">üì± QR</option>
            </select>
          </div>

          <!-- Campos din√°micos -->
          <div id="metodoCampos" class="mt-3"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Confirmar pago</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SCRIPTS -->
<!-- ========================================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const modalPagar = document.getElementById('modalPagar');
  const metodoSelect = document.getElementById('metodo');
  const camposDiv = document.getElementById('metodoCampos');

  // Cuando se abre el modal
  modalPagar.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const idPago = button.getAttribute('data-id');
    const monto = button.getAttribute('data-monto');
    document.getElementById('id_pago').value = idPago;
    document.getElementById('monto_pago').textContent = monto;
    camposDiv.innerHTML = '';
    metodoSelect.value = '';
  });

  // Cambia los campos seg√∫n el m√©todo
  metodoSelect.addEventListener('change', () => {
    const metodo = metodoSelect.value;
    camposDiv.innerHTML = '';

    if (metodo === 'tarjeta') {
      camposDiv.innerHTML = `
        <div class="mb-3">
          <label class="form-label">N√∫mero de tarjeta</label>
          <input type="text" name="numero_tarjeta" maxlength="16" class="form-control" required>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Vencimiento</label>
            <input type="text" name="vencimiento" placeholder="MM/AA" maxlength="5" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">CVV</label>
            <input type="password" name="cvv" maxlength="3" class="form-control" required>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">C√≥digo / Referencia</label>
          <input type="text" name="codigo" class="form-control" placeholder="Ej: TXN12345" required>
        </div>
      `;
    } 
    else if (metodo === 'transferencia') {
      camposDiv.innerHTML = `
        <div class="mb-3">
          <label class="form-label">Banco</label>
          <input type="text" name="banco" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">N√∫mero de cuenta</label>
          <input type="text" name="cuenta" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">C√≥digo de comprobante</label>
          <input type="text" name="codigo" class="form-control" placeholder="Ej: TRX12345" required>
        </div>
      `;
    } 
    else if (metodo === 'qr') {
      const codigo = `QR-${Date.now()}`;
      camposDiv.innerHTML = `
        <div class="text-center">
          <p>Escanea este c√≥digo para completar el pago:</p>
          <img src="{{ url_for('static', filename='images/qr_demo.png') }}" 
               alt="QR de pago" 
               width="200" 
               height="200"
               class="rounded shadow-sm mb-2 border">
          <div><small class="text-muted">Usa la referencia mostrada al confirmar.</small></div>
          <input type="hidden" name="codigo" value="${codigo}">
        </div>
      `;
    }
  });
});
</script>

{% endblock %}
