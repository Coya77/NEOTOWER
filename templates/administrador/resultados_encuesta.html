<!-- templates/administrador/resultados_encuesta.html (versión corregida: fix loop y float %) -->
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-bar-chart"></i> Resultados de Encuesta: {{ encuesta.titulo if encuesta else 'No encontrada' }}</h2>
        <a href="{{ url_for('votaciones.admin_gestion_encuestas') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Gestión
        </a>
    </div>

    <!-- Flashes -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if encuesta %}
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5>Detalles de la Encuesta</h5>
            </div>
            <div class="card-body">
                <p><strong>Descripción:</strong> {{ encuesta.descripcion or 'Sin descripción' }}</p>
                <p><strong>Fecha Inicio:</strong> {{ encuesta.fecha_inicio.strftime('%d/%m/%Y') if encuesta.fecha_inicio else 'N/A' }}</p>
                <p><strong>Fecha Fin:</strong> {{ encuesta.fecha_fin.strftime('%d/%m/%Y') if encuesta.fecha_fin else 'N/A' }}</p>
                <p><strong>Estado:</strong> 
                    <span class="badge {{ 'bg-success' if encuesta.activa else 'bg-secondary' }}">
                        {{ 'Activa' if encuesta.activa else 'Finalizada' }}
                    </span>
                </p>
                <p><strong>Total Votos:</strong> {{ stats.total_votos or 0 }}</p>
                <p><strong>Total Opciones:</strong> {{ stats.total_opciones or 0 }}</p>
                <p><strong>Participación Estimada:</strong> {{ stats.participacion or 0 }}% (basado en ~100 residentes)</p>
            </div>
        </div>

        <!-- Resultados por Opción (Tabla + Barras de Progreso) -->
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5>Resultados Detallados</h5>
            </div>
            <div class="card-body">
                {% if opciones and opciones|length > 0 %}
                    <!-- FIX: Loop seguro solo si hay opciones -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Opción</th>
                                    <th>Votos</th>
                                    <th>Porcentaje</th>
                                    <th>Gráfico</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for opcion in opciones %}
                                <tr>
                                    <td><strong>{{ opcion.texto }}</strong></td>
                                    <td>{{ opcion.votos or 0 }}</td>
                                    <td>{{ (opcion.porcentaje or 0)|round(1) }}%</td>
                                    <td>
                                        <!-- FIX: Width con round(1) y default 0 para evitar NaN/None en CSS -->
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-primary" 
                                                 role="progressbar" 
                                                 style="width: {% raw %}{{ (opcion.porcentaje or 0) | round(1) }}%{% endraw %};"
                                                 aria-valuenow="{{ (opcion.porcentaje or 0)|round(1) }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ (opcion.porcentaje or 0)|round(1) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <!-- FIX: Manejo si no hay opciones/votos -->
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Sin Resultados Aún</h6>
                        <p>No hay votos registrados en esta encuesta. Espera participación de residentes.</p>
                        <p><strong>Total Votos:</strong> <span class="badge bg-secondary">{{ stats.total_votos or 0 }}</span></p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Ganadora (Opcional: Opción con más votos) -->
        {% if opciones and opciones|length > 0 %}
        {% set ganadora = opciones[0] if opciones else None %}
        <div class="alert alert-info mt-4">
            <h6><i class="bi bi-trophy"></i> Opción Ganadora:</h6>
            <p><strong>{{ ganadora.texto if ganadora else 'N/A' }}</strong> con {{ ganadora.votos if ganadora else 0 }} votos ({{ (ganadora.porcentaje or 0)|round(1) }}%).</p>
        </div>
        {% endif %}

    {% else %}
        <div class="alert alert-warning">
            <h5>Encuesta No Encontrada</h5>
            <p>Los resultados no están disponibles. Verifica el ID o regresa a gestión.</p>
        </div>
    {% endif %}
</div>

<!-- Debug: Abre F12 > Console para ver errores Jinja2 si persiste -->
<script>
    // Aquí actualizas el estilo dinámicamente
    const bar = document.querySelector('.progress-bar');
    const porcentaje = bar.getAttribute('data-porcentaje');
    bar.style.width = `${porcentaje}%`;
</script>
{% endblock %}