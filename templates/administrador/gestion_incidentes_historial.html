{% extends "base.html" %}

{% block title %}Historial Completo de Incidentes{% endblock %}

{% block content %}

<div class="container-fluid">
    <h2 class="mb-4">Historial Completo de Incidentes</h2>
    <p class="text-muted">Detalle y seguimiento de todas las incidencias reportadas en Neotower.</p>
    <hr>
    
    <!-- Filtros (Se puede implementar la lógica de JS/Flask después) -->
    <div class="card p-3 mb-4 shadow-sm">
        <form class="form-row">
            <div class="col-md-3 mb-2">
                <input type="text" class="form-control" placeholder="Buscar por Descripción/Residente">
            </div>
            <div class="col-md-2 mb-2">
                <select class="form-control">
                    <option value="">Filtrar por Estado</option>
                    <option>Abierto/Pendiente</option>
                    <option>En Progreso</option>
                    <option>Cerrado</option>
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <select class="form-control">
                    <option value="">Filtrar por Gravedad</option>
                    <option>Alta</option>
                    <option>Media</option>
                    <option>Baja</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <input type="date" class="form-control" placeholder="Fecha Desde">
            </div>
            <div class="col-md-2 mb-2">
                <button type="submit" class="btn btn-primary btn-block">Aplicar Filtros</button>
            </div>
        </form>
    </div>

    <!-- Tabla de Historial -->
    <div class="card shadow-sm">
        <div class="card-body">
            {% if incidentes %}
            <div class="table-responsive">
                <table class="table table-striped table-hover small">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Estado</th>
                            <th>Gravedad</th>
                            <th>Descripción</th>
                            <th>Reportado Por</th>
                            <th>Depto</th>
                            <th>Fecha Reporte</th>
                            <th>Asignado A</th>
                            <th>Fecha Cierre</th>
                            <th>Costo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in incidentes %}
                        <tr>
                            <td>{{ i.id_incidente }}</td>
                            <td>
                                <span class="badge 
                                    {% if i.estado == 'Abierto/Pendiente' %}bg-warning text-dark
                                    {% elif i.estado == 'En Progreso' %}bg-info text-white
                                    {% elif i.estado == 'Cerrado' %}bg-success text-white
                                    {% endif %}">{{ i.estado }}</span>
                            </td>
                            <td><span class="badge 
                                {% if i.gravedad == 'Alta' %}bg-danger
                                {% elif i.gravedad == 'Media' %}bg-warning text-dark
                                {% else %}bg-secondary
                                {% endif %}">{{ i.gravedad }}</span>
                            </td>
                            <td>{{ i.descripcion | truncate(80) }}</td>
                            <td>{{ i.residente_nombre }} {{ i.residente_apellido }}</td>
                            <td>#{{ i.depto_numero | default('N/A') }}</td>
                            <td>{{ i.fecha_reporte.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ i.personal_asignado_nombre | default('Pendiente') }}</td>
                            <td>{{ i.fecha_cierre.strftime('%Y-%m-%d') if i.fecha_cierre else '---' }}</td>
                            <td>${{ i.costo_reparacion | default('0.00') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                Aún no hay incidentes registrados en el historial.
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="mt-3">
        <a href="{{ url_for('gestion_incidentes') }}" class="btn btn-outline-secondary">
            ← Volver al Dashboard de Incidentes
        </a>
    </div>

</div>

{% endblock %}
